<script type="text/javascript">
    var url, dispatchParameter;
    function addClick() {
        $('#dlg').dialog('open').dialog('setTitle', '新增');
        addKey = true;
        $('#workDispatchTable').datagrid({ url: '/SortOrderDispatch/GetBatchStatus/' }); //加载线路分配信息
        $('#NormalworkDispatchTable').datagrid({ url: '/SortOrderDispatch/GetNormalBatch/' }); //加载线路分配信息
        $('#AbnormalworkDispatchTable').datagrid({ url: '/SortOrderDispatch/GetAbnormalBatch/' }); //加载线路分配信息
        $('#PieceworkDispatchTable').datagrid({ url: '/SortOrderDispatch/GetPieceBatch/' }); //加载线路分配信息
        $('#ManualworkDispatchTable').datagrid({ url: '/SortOrderDispatch/GetManualBatch/' }); //加载线路分配信息
    }

    function normalTask() {
        $('#NormalworkDispatchTable').datagrid({ url: '/SortOrderDispatch/GetBatchStatus/' }); 
    }

    function save() {
        var tabsRow = $('#checkTabs').tabs('getSelected');
        dispatchParameter = "";
        var dispatchRows;
        var productType;
        if (tabsRow.panel('options').id == "AllTask") {
            dispatchRows = $('#workDispatchTable').datagrid('getSelections');
            productType="0";
        }
        else if (tabsRow.panel('options').id == "NormalTask") {
            dispatchRows = $('#NormalworkDispatchTable').datagrid('getSelections');
             productType="1";
        }
        else if (tabsRow.panel('options').id == "AbnormalTask") {
            dispatchRows = $('#AbnormalworkDispatchTable').datagrid('getSelections');
             productType="2";
        }
        else if (tabsRow.panel('options').id == "PieceTask") {
            dispatchRows = $('#PieceworkDispatchTable').datagrid('getSelections');
             productType="3";
        }
        else if (tabsRow.panel('options').id == "Manual") {
            dispatchRows = $('#ManualworkDispatchTable').datagrid('getSelections');
             productType="4";
         }
        for (var i = 0; i < dispatchRows.length; i++) {
            dispatchParameter += dispatchRows[i].ID + ",";
        }
        if (dispatchParameter != "" && dispatchParameter != null) {
            $.ajax({
                url: "/SortBatchDispatch/Create",
                type: "POST",
                data: { dispatchId: dispatchParameter, productType: productType },
                success: function (result) {
                    var result = eval('(' + result + ')');
                    if (result.success) {
                        $.messager.alert(g_MsgBoxTitle, result.msg, "info");
                        $('#dlg').dialog('close');
                        $('#details').datagrid('reload');
                    } else {
                        $.messager.alert(g_MsgBoxTitle, result.msg + '<br />' + result.data, "error");
                        $('#details').datagrid('reload');
                    }
                }
            });
        } else {
            $.messager.alert('错误', '请选择需要作业调度的线路！');
            addKey = false;
            editKey = false;
        }
    }

    function countSum() {
        var countSum = 0;
        var outQuantitySum = 0;
        var rows = $('#workDispatchTable').datagrid('getRows');
        if (rows.length > 0) {
            for (var i = 0; i < rows.length; i++) {
                countSum = parseInt(countSum) + rows[i].QuantitySum;
                outQuantitySum = countSum / 50;
            }
            $('#countQuantitySum').text(countSum);
            $('#outBillQuantitySum').text(outQuantitySum);
        } else {
            $('#countQuantitySum').text(0);
        }
    }

    function SelectQuantity() {
        var quantitySum = 0;
        var rows = $('#workDispatchTable').datagrid('getChecked');
        if (rows.length > 0) {
            for (var i = 0; i < rows.length; i++) {
                quantitySum = parseInt(quantitySum) + rows[i].QuantitySum;
            }
            $('#checkQuantitySum').text(quantitySum);
        } else {
            $('#checkQuantitySum').text(0);
        }
    }

    $(function () {
        $('#workDispatchTable').datagrid({
            onClickRow: function () {
                var quantitySum = 0;
                var rows = $('#workDispatchTable').datagrid('getSelections');
                if (rows.length > 0) {
                    for (var i = 0; i < rows.length; i++) {
                        quantitySum = parseInt(quantitySum) + rows[i].QuantitySum;
                    }
                    $('#checkQuantitySum').text(quantitySum);
                } else {
                    $('#checkQuantitySum').text(0);
                }
            },
            onLoadSuccess: function () {//数据加载完后执行
                countSum();
            }
        })
    });
</script>
<div id="dlg" class="easyui-dialog" modal="true" style="width:780px; height:510px"
    closed="true" buttons="#dlg-buttons">
     <div id="checkTabs" class="easyui-tabs" fit="true">
        <div title="所有作业" id="AllTask">
            <div class="easyui-layout" fit="true">
          <div id="main" region="center" fit="true" border="false" style="margin: 1px">
            <table id="workDispatchTable" class="easyui-datagrid" singleSelect="false" pagination="fasle" 
                    border="false" fit="true" rownumbers="true" toolbar="#bar" fitColumns="true" showFooter="true" pageSize="50">
                <thead>
                     <tr>
                        <th field="ck" checkbox="true">
                        <th field="ID" width="120" hidden="true">调度ID</th>
                        <th field="OrderDate" width="70" >订单日期</th>
                        <th field="SortingLineCode" width="60" >分拣线编码</th>
                        <th field="SortingLineName" width="110" >分拣线名称</th>
                        <th field="DeliverLineCode" width="80" hidden="true">送货线路编码</th>
                        <th field="DeliverLineName" width="170" >送货线路名称</th>
                        <th field="QuantitySum" width="60">数量</th>
                        <th field="SortStatus" width="80" >分拣状态</th>
                        <th field="IsActive" width="80">是否可用</th>
                        <th field="UpdateTime" width="70">修改时间</th>
                    </tr>
                </thead>
            </table>
            </div>
           </div>
        </div>
        <div title="正常作业" id="NormalTask"><div style=" width:70px; height:25px; margin-left:80px; margin-top:-30px; position:absolute; "  onclick="normalTask()"></div>
         <div class="easyui-layout" fit="true">
          <div id="Normal" region="center" fit="true" border="false" style="margin: 1px">
            <table id="NormalworkDispatchTable" class="easyui-datagrid" singleSelect="false" pagination="fasle" 
                    border="false" fit="true" rownumbers="true" toolbar="#bar" fitColumns="true" showFooter="true" pageSize="50">
                <thead>
                     <tr>
                        <th field="ck" checkbox="true">
                        <th field="ID" width="120" hidden="true">调度ID</th>
                        <th field="OrderDate" width="70" >订单日期</th>
                        <th field="SortingLineCode" width="60" >分拣线编码</th>
                        <th field="SortingLineName" width="110" >分拣线名称</th>
                        <th field="DeliverLineCode" width="80" hidden="true">送货线路编码</th>
                        <th field="DeliverLineName" width="170" >送货线路名称</th>
                        <th field="QuantitySum" width="60">数量</th>
                        <th field="SortStatus" width="80" >分拣状态</th>
                        <th field="IsActive" width="80">是否可用</th>
                        <th field="UpdateTime" width="70">修改时间</th>
                    </tr>
                </thead>
            </table>
            </div>
           </div>
        </div>
        <div title="异型作业" id="AbnormalTask">
         <div class="easyui-layout" fit="true">
          <div id="Abnormal" region="center" fit="true" border="false" style="margin: 1px">
            <table id="AbnormalworkDispatchTable" class="easyui-datagrid" singleSelect="false" pagination="fasle" 
                    border="false" fit="true" rownumbers="true" toolbar="#bar" fitColumns="true" showFooter="true" pageSize="50">
                <thead>
                     <tr>
                        <th field="ck" checkbox="true">
                        <th field="ID" width="120" hidden="true">调度ID</th>
                        <th field="OrderDate" width="70" >订单日期</th>
                        <th field="SortingLineCode" width="60" >分拣线编码</th>
                        <th field="SortingLineName" width="110" >分拣线名称</th>
                        <th field="DeliverLineCode" width="80" hidden="true">送货线路编码</th>
                        <th field="DeliverLineName" width="170" >送货线路名称</th>
                        <th field="QuantitySum" width="60">数量</th>
                        <th field="SortStatus" width="80" >分拣状态</th>
                        <th field="IsActive" width="80">是否可用</th>
                        <th field="UpdateTime" width="70">修改时间</th>
                    </tr>
                </thead>
            </table>
            </div>
           </div>
        </div>
        <div title="整件作业" id="PieceTask">
         <div class="easyui-layout" fit="true">
          <div id="Piece" region="center" fit="true" border="false" style="margin: 1px">
            <table id="PieceworkDispatchTable" class="easyui-datagrid" singleSelect="false" pagination="fasle" 
                    border="false" fit="true" rownumbers="true" toolbar="#bar" fitColumns="true" showFooter="true" pageSize="50">
                <thead>
                     <tr>
                        <th field="ck" checkbox="true">
                        <th field="ID" width="120" hidden="true">调度ID</th>
                        <th field="OrderDate" width="70" >订单日期</th>
                        <th field="SortingLineCode" width="60" >分拣线编码</th>
                        <th field="SortingLineName" width="110" >分拣线名称</th>
                        <th field="DeliverLineCode" width="80" hidden="true">送货线路编码</th>
                        <th field="DeliverLineName" width="170" >送货线路名称</th>
                        <th field="QuantitySum" width="60">数量</th>
                        <th field="SortStatus" width="80" >分拣状态</th>
                        <th field="IsActive" width="80">是否可用</th>
                        <th field="UpdateTime" width="70">修改时间</th>
                    </tr>
                </thead>
            </table>
            </div>
           </div>
        </div>
        <div title="手工作业" id="ManualTask">
         <div class="easyui-layout" fit="true">
          <div id="Manual" region="center" fit="true" border="false" style="margin: 1px">
            <table id="ManualworkDispatchTable" class="easyui-datagrid" singleSelect="false" pagination="fasle" 
                    border="false" fit="true" rownumbers="true" toolbar="#bar" fitColumns="true" showFooter="true" pageSize="50">
                <thead>
                     <tr>
                        <th field="ck" checkbox="true">
                        <th field="ID" width="120" hidden="true">调度ID</th>
                        <th field="OrderDate" width="70" >订单日期</th>
                        <th field="SortingLineCode" width="60" >分拣线编码</th>
                        <th field="SortingLineName" width="110" >分拣线名称</th>
                        <th field="DeliverLineCode" width="80" hidden="true">送货线路编码</th>
                        <th field="DeliverLineName" width="170" >送货线路名称</th>
                        <th field="QuantitySum" width="60">数量</th>
                        <th field="SortStatus" width="80" >分拣状态</th>
                        <th field="IsActive" width="80">是否可用</th>
                        <th field="UpdateTime" width="70">修改时间</th>
                    </tr>
                </thead>
            </table>
            </div>
           </div>
        </div>
    </div>
</div>
<div id="dlg-buttons">
<table style="width:800px;">
<tr>
    <td style="width:100px;">
        <label>总数量：</label>
        <b><label id="countQuantitySum" style="font-size:20px; font-family:微软雅黑; color:Red;"></label></b><label>（条）</label>
        @*<label>/ 50 ≈ </label><label id="outBillQuantitySum"></label><label>（件）</label>*@
        <b><label style="font-size:20px; font-family:微软雅黑; color:Red;">请核对营销系统（v3）数据！</label><b>
    </td>
    <td style="width:60px;">
        <label>选中量：</label>
        <label id="checkQuantitySum"></label><label>（条）</label>
    </td>
</tr>
</table>
    <a href="#" class="easyui-linkbutton" iconcls="icon-ok" onclick="save()">调度</a>
    <a href="#" class="easyui-linkbutton" iconcls="icon-cancel" onclick="javascript:$('#dlg').dialog('close')">
        取消</a>
</div>

